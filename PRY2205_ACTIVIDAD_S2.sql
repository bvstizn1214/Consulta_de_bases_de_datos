
DROP TABLE DETALLE_FACTURA CASCADE CONSTRAINTS;
DROP TABLE FACTURA CASCADE CONSTRAINTS;
DROP TABLE DETALLE_BOLETA CASCADE CONSTRAINTS;
DROP TABLE BOLETA CASCADE CONSTRAINTS;
DROP TABLE REMUN_MENSUAL_VENDEDOR CASCADE CONSTRAINTS;
DROP TABLE VENDEDOR CASCADE CONSTRAINTS;
DROP TABLE CLIENTE CASCADE CONSTRAINTS;
DROP TABLE PRODUCTO CASCADE CONSTRAINTS;
DROP TABLE UNIDAD_MEDIDA CASCADE CONSTRAINTS;
DROP TABLE FORMA_PAGO CASCADE CONSTRAINTS;
DROP TABLE BANCO CASCADE CONSTRAINTS;
DROP TABLE TRAMO_ANTIGÜEDAD CASCADE CONSTRAINTS;
DROP TABLE TRAMO_ESCOLARIDAD CASCADE CONSTRAINTS;
DROP TABLE ESCOLARIDAD CASCADE CONSTRAINTS;
DROP TABLE COMUNA CASCADE CONSTRAINTS;
DROP TABLE CIUDAD CASCADE CONSTRAINTS;
DROP TABLE PAIS CASCADE CONSTRAINTS;


CREATE TABLE PAIS (
    CODPAIS NUMBER(2) PRIMARY KEY,
    NOMPAIS VARCHAR2(30)
);

CREATE TABLE CIUDAD (
    CODCIUDAD NUMBER(2) PRIMARY KEY,
    DESCRIPCION VARCHAR2(20)
);

CREATE TABLE COMUNA (
    CODCOMUNA NUMBER(2) PRIMARY KEY,
    DESCRIPCION VARCHAR2(30),
    CODCIUDAD NUMBER(2),
    CONSTRAINT FK_COD_CIUDAD FOREIGN KEY (CODCIUDAD) REFERENCES CIUDAD(CODCIUDAD)
);

CREATE TABLE ESCOLARIDAD (
    ID_ESCOLARIDAD NUMBER(2) PRIMARY KEY,
    DESC_ESCOLARIDAD VARCHAR2(30),
    DESC_ESCOLARIDAD_AD VARCHAR2(50)
);

CREATE TABLE TRAMO_ESCOLARIDAD (
    ID_ESCOLARIDAD NUMBER(2),
    FECHA_VIGENCIA DATE,
    PORC_AJSO_ESCOLARIDAD NUMBER(2),
    PRIMARY KEY (ID_ESCOLARIDAD, FECHA_VIGENCIA),
    CONSTRAINT FK_TRAMO_ESCOLARIDAD FOREIGN KEY (ID_ESCOLARIDAD) REFERENCES ESCOLARIDAD(ID_ESCOLARIDAD)
);

CREATE TABLE TRAMO_ANTIGÜEDAD (
    SEC_ANIOS_CONTRATADO NUMBER(2),
    FEC_INI_VIG DATE,
    FEC_FIN_VIG DATE,
    ANIOS_CONT_SUP NUMBER(2),
    PORC_ANTIG NUMBER(2),
    PRIMARY KEY (SEC_ANIOS_CONTRATADO, FEC_INI_VIG)
);

CREATE TABLE BANCO (
    COBBANCO NUMBER(2) PRIMARY KEY,
    DESCRIPCION VARCHAR2(30)
);

CREATE TABLE FORMA_PAGO (
    CODPAGO NUMBER(2) PRIMARY KEY,
    DESCRIPCION VARCHAR2(20)
);

CREATE TABLE UNIDAD_MEDIDA (
    CODUNIDAD VARCHAR2(2) PRIMARY KEY,
    DESCRIPCION VARCHAR2(42)
);

CREATE TABLE PRODUCTO (
    COPRODUCTO NUMBER(2) PRIMARY KEY,
    DESCRIPCION VARCHAR2(50),
    CODUNIDAD VARCHAR2(2),
    VUNTARIO NUMBER(8),
    VALORCOMPRAALCUR1 NUMBER(8,2),
    VALORCOMPRAALCUR2 NUMBER(8,2),
    VALORCOMPRAALCUR3 NUMBER(8,2),
    VALORCOMPRAALCUR4 NUMBER(8,2),
    VALORCOMPRAALCUR5 NUMBER(8,2),
    TRASECUENCIA NUMBER(2),
    PROCEDENCIA VARCHAR2(2),
    COPRODUCTO_REL NUMBER(2),
    COD_PAIS NUMBER(2),
    STOCK NUMBER(8)
);

CREATE TABLE CLIENTE (
    RUTCLIENTE VARCHAR2(10) PRIMARY KEY,
    NOMBRE VARCHAR2(20),
    DIRECCION VARCHAR2(42),
    TELEFONO NUMBER(12),
    ESTADO VARCHAR2(10),
    MAIL VARCHAR2(42),
    CREDITO NUMBER(8),
    SALDO NUMBER(8),
    CODCOMUNA NUMBER(2),
    CONSTRAINT FK_COD_COMUNA_CLI FOREIGN KEY (CODCOMUNA) REFERENCES COMUNA(CODCOMUNA)
);

CREATE TABLE VENDEDOR (
    RUTVENDEDOR VARCHAR2(10) PRIMARY KEY,
    ID NUMBER(2),
    NOMBRE VARCHAR2(20),
    DIRECCION VARCHAR2(42),
    CODCOMUNA NUMBER(2),
    TELEFONO NUMBER(12),
    MAIL VARCHAR2(42),
    COMISION NUMBER(3,2),
    FECHA_CONTRATO DATE,
    ID_ESCOLARIDAD NUMBER(2),
    CONSTRAINT FK_COD_COMUNA_VEN FOREIGN KEY (CODCOMUNA) REFERENCES COMUNA(CODCOMUNA),
    CONSTRAINT FK_ID_ESCOLARIDAD FOREIGN KEY (ID_ESCOLARIDAD) REFERENCES ESCOLARIDAD(ID_ESCOLARIDAD)
);

CREATE TABLE REMUN_MENSUAL_VENDEDOR (
    RUTVENDEDOR VARCHAR2(10),
    FECHA_REMUN DATE,
    SUELDO_BASE NUMBER(8),
    MOVILIZACION NUMBER(8),
    COLACION NUMBER(8),
    TOTAL_PREMIOS NUMBER(8),
    TOTAL_DESCUENTOS NUMBER(8),
    TOTAL_LIQUIDO NUMBER(8),
    PRIMARY KEY (RUTVENDEDOR, FECHA_REMUN),
    CONSTRAINT FK_REMUN_VEN FOREIGN KEY (RUTVENDEDOR) REFERENCES VENDEDOR(RUTVENDEDOR)
);

CREATE TABLE BOLETA (
    NUMBOLETA NUMBER(7) PRIMARY KEY,
    FULTBOLETA VARCHAR2(12),
    RUTVENDEDOR VARCHAR2(10),
    FECHA DATE,
    TOTAL NUMBER(8),
    CODPAGO NUMBER(2),
    COBBANCO NUMBER(2),
    NUM_DOCCTO_PAGO VARCHAR2(12),
    ESTADO VARCHAR2(2),
    CONSTRAINT FK_RUTVENDEDOR_BOL FOREIGN KEY (RUTVENDEDOR) REFERENCES VENDEDOR(RUTVENDEDOR),
    CONSTRAINT FK_CODPAGO_BOL FOREIGN KEY (CODPAGO) REFERENCES FORMA_PAGO(CODPAGO),
    CONSTRAINT FK_COBBANCO_BOL FOREIGN KEY (COBBANCO) REFERENCES BANCO(COBBANCO)
);

CREATE TABLE DETALLE_BOLETA (
    NUMBOLETA NUMBER(7),
    COPRODUCTO NUMBER(2),
    VUNTARIO NUMBER(8),
    DESCUENTO NUMBER(8),
    DESCU_PROM NUMBER(8),
    CANTIDAD NUMBER(8),
    TOTALLINEA NUMBER(8),
    PRIMARY KEY (NUMBOLETA, COPRODUCTO),
    CONSTRAINT FK_DET_BOLETA_NUMBOLETA FOREIGN KEY (NUMBOLETA) REFERENCES BOLETA(NUMBOLETA),
    CONSTRAINT FK_DET_BOLETA_COPRODUCTO FOREIGN KEY (COPRODUCTO) REFERENCES PRODUCTO(COPRODUCTO)
);

CREATE TABLE FACTURA (
    NUMFACTURA NUMBER(7) PRIMARY KEY,
    CODPRODUCTO NUMBER(2),
    VUNTARIO NUMBER(8),
    RUTCLIENTE VARCHAR2(10),
    FECHAEMISION DATE,
    NETO NUMBER(8),
    IVA NUMBER(8),
    TOTALFACTURA NUMBER(8),
    CODPAGO NUMBER(2),
    COBBANCO NUMBER(2),
    CONSTRAINT FK_FACTURA_CODPRODUCTO FOREIGN KEY (CODPRODUCTO) REFERENCES PRODUCTO(COPRODUCTO),
    CONSTRAINT FK_FACTURA_RUTCLIENTE FOREIGN KEY (RUTCLIENTE) REFERENCES CLIENTE(RUTCLIENTE),
    CONSTRAINT FK_FACTURA_CODPAGO FOREIGN KEY (CODPAGO) REFERENCES FORMA_PAGO(CODPAGO),
    CONSTRAINT FK_FACTURA_COBBANCO FOREIGN KEY (COBBANCO) REFERENCES BANCO(COBBANCO)
);

CREATE TABLE DETALLE_FACTURA (
    NUMFACTURA NUMBER(7),
    COPRODUCTO NUMBER(2),
    VUNTARIO NUMBER(8),
    DESCUENTO NUMBER(8),
    DESCU_PROM NUMBER(8),
    CANTIDAD NUMBER(8),
    TOTALLINEA NUMBER(8),
    PRIMARY KEY (NUMFACTURA, COPRODUCTO),
    CONSTRAINT FK_DET_FACT_NUMFACT FOREIGN KEY (NUMFACTURA) REFERENCES FACTURA(NUMFACTURA),
    CONSTRAINT FK_DET_FACT_COPROD FOREIGN KEY (COPRODUCTO) REFERENCES PRODUCTO(COPRODUCTO)
);


INSERT INTO PAIS (CODPAIS, NOMPAIS) VALUES (1, 'Chile');

INSERT INTO CIUDAD (CODCIUDAD, DESCRIPCION) VALUES (1, 'Santiago');
INSERT INTO CIUDAD (CODCIUDAD, DESCRIPCION) VALUES (2, 'Valparaiso');
INSERT INTO CIUDAD (CODCIUDAD, DESCRIPCION) VALUES (4, 'Concepcion');
INSERT INTO CIUDAD (CODCIUDAD, DESCRIPCION) VALUES (8, 'Antofagasta');

INSERT INTO COMUNA (CODCOMUNA, DESCRIPCION, CODCIUDAD) VALUES (1, 'Las Condes', 1);
INSERT INTO COMUNA (CODCOMUNA, DESCRIPCION, CODCIUDAD) VALUES (2, 'Viña del Mar', 2);
INSERT INTO COMUNA (CODCOMUNA, DESCRIPCION, CODCIUDAD) VALUES (4, 'Talcahuano', 4);
INSERT INTO COMUNA (CODCOMUNA, DESCRIPCION, CODCIUDAD) VALUES (8, 'Mejillones', 8);

INSERT INTO ESCOLARIDAD (ID_ESCOLARIDAD, DESC_ESCOLARIDAD, DESC_ESCOLARIDAD_AD) VALUES (1, 'Basica', 'Educación Básica');
INSERT INTO ESCOLARIDAD (ID_ESCOLARIDAD, DESC_ESCOLARIDAD, DESC_ESCOLARIDAD_AD) VALUES (2, 'Media', 'Educación Media');

INSERT INTO TRAMO_ESCOLARIDAD (ID_ESCOLARIDAD, FECHA_VIGENCIA, PORC_AJSO_ESCOLARIDAD) VALUES (1, SYSDATE, 10);

INSERT INTO TRAMO_ANTIGÜEDAD (SEC_ANIOS_CONTRATADO, FEC_INI_VIG, FEC_FIN_VIG, ANIOS_CONT_SUP, PORC_ANTIG) VALUES (1, SYSDATE, SYSDATE, 5, 10);

INSERT INTO BANCO (COBBANCO, DESCRIPCION) VALUES (1, 'Banco Estado');
INSERT INTO BANCO (COBBANCO, DESCRIPCION) VALUES (2, 'Banco Chile');

INSERT INTO FORMA_PAGO (CODPAGO, DESCRIPCION) VALUES (1, 'EFECTIVO');
INSERT INTO FORMA_PAGO (CODPAGO, DESCRIPCION) VALUES (2, 'TARJETA DEBITO');
INSERT INTO FORMA_PAGO (CODPAGO, DESCRIPCION) VALUES (3, 'TARJETA CREDITO');
INSERT INTO FORMA_PAGO (CODPAGO, DESCRIPCION) VALUES (4, 'CHEQUE');

INSERT INTO UNIDAD_MEDIDA (CODUNIDAD, DESCRIPCION) VALUES ('UN', 'Unidad');
INSERT INTO UNIDAD_MEDIDA (CODUNIDAD, DESCRIPCION) VALUES ('PR', 'Par');

INSERT INTO CLIENTE (RUTCLIENTE, NOMBRE, DIRECCION, TELEFONO, ESTADO, MAIL, CREDITO, SALDO, CODCOMUNA)
VALUES ('12444650-7', 'Juan Lopez', 'Calle X', 96644123, 'A', 'juan.lopez@gmail.com', 1000000, 303450, 8);
INSERT INTO CLIENTE (RUTCLIENTE, NOMBRE, DIRECCION, TELEFONO, ESTADO, MAIL, CREDITO, SALDO, CODCOMUNA)
VALUES ('18125781-8', 'Patricia Fuentes', 'Calle Y', NULL, 'A', 'patricia.fuentes@gmail.com', 600000, 560000, 2);
INSERT INTO CLIENTE (RUTCLIENTE, NOMBRE, DIRECCION, TELEFONO, ESTADO, MAIL, CREDITO, SALDO, CODCOMUNA)
VALUES ('15446780-0', 'Carlos Mendoza', 'Calle Z', NULL, 'A', NULL, 900000, 850000, 1);
INSERT INTO CLIENTE (RUTCLIENTE, NOMBRE, DIRECCION, TELEFONO, ESTADO, MAIL, CREDITO, SALDO, CODCOMUNA)
VALUES ('13685017-1', 'Johnny Yanez', 'Calle W', 78598619, 'A', 'johnny.yanez@gmail.com', 800000, 689450, NULL);


INSERT INTO PRODUCTO (COPRODUCTO, DESCRIPCION, CODUNIDAD, VUNTARIO, VALORCOMPRAALCUR1, TRASECUENCIA, PROCEDENCIA, STOCK)
VALUES (18, 'Zapato Mujer Modelo Sydney 12-6', 'UN', 0, 6.8, 0, 'i', 25);
INSERT INTO PRODUCTO (COPRODUCTO, DESCRIPCION, CODUNIDAD, VUNTARIO, VALORCOMPRAALCUR1, TRASECUENCIA, PROCEDENCIA, STOCK)
VALUES (17, 'Zapato Mujer Modelo Lombardo 11-5', 'UN', 0, NULL, 0, 'i', 34);
INSERT INTO PRODUCTO (COPRODUCTO, DESCRIPCION, CODUNIDAD, VUNTARIO, VALORCOMPRAALCUR1, TRASECUENCIA, PROCEDENCIA, STOCK)
VALUES (16, 'Zapato Mujer Modelo Montecarlo 4-10', 'UN', 0, 5.225, 0, 'i', 54);
INSERT INTO PRODUCTO (COPRODUCTO, DESCRIPCION, CODUNIDAD, VUNTARIO, VALORCOMPRAALCUR1, TRASECUENCIA, PROCEDENCIA, STOCK)
VALUES (15, 'Zapato Mujer Modelo Montreal 3-201', 'UN', 0, 8.77, 0, 'i', 20);
INSERT INTO PRODUCTO (COPRODUCTO, DESCRIPCION, CODUNIDAD, VUNTARIO, VALORCOMPRAALCUR1, TRASECUENCIA, PROCEDENCIA, STOCK)
VALUES (14, 'Zapato Mujer Modelo Ramblas 2-20', 'UN', 0, 15.85, 0, 'i', 35);


INSERT INTO FACTURA (NUMFACTURA, CODPRODUCTO, VUNTARIO, RUTCLIENTE, FECHAEMISION, NETO, IVA, TOTALFACTURA, CODPAGO, COBBANCO)
VALUES (11529, 18, 1, '18125781-8', TO_DATE('08-03-2024', 'DD-MM-YYYY'), 21900, 4161, 26061, 1, 1);
INSERT INTO FACTURA (NUMFACTURA, CODPRODUCTO, VUNTARIO, RUTCLIENTE, FECHAEMISION, NETO, IVA, TOTALFACTURA, CODPAGO, COBBANCO)
VALUES (11528, 17, 1, '15446780-0', TO_DATE('07-03-2024', 'DD-MM-YYYY'), 29700, 5643, 35343, 4, 1);
INSERT INTO FACTURA (NUMFACTURA, CODPRODUCTO, VUNTARIO, RUTCLIENTE, FECHAEMISION, NETO, IVA, TOTALFACTURA, CODPAGO, COBBANCO)
VALUES (11527, 18, 1, '18125781-8', TO_DATE('07-03-2024', 'DD-MM-YYYY'), 29700, 5643, 35343, 1, 1);
INSERT INTO FACTURA (NUMFACTURA, CODPRODUCTO, VUNTARIO, RUTCLIENTE, FECHAEMISION, NETO, IVA, TOTALFACTURA, CODPAGO, COBBANCO)
VALUES (11526, 17, 1, '13685017-1', TO_DATE('17-02-2024', 'DD-MM-YYYY'), 29700, 5643, 35343, 3, 1);

UPDATE PRODUCTO SET VALORCOMPRAALCUR1 = 6.8 WHERE COPRODUCTO = 18;

SELECT
    NUMFACTURA AS "N° Factura",
    INITCAP(TO_CHAR(FECHAEMISION, 'DD "de" Month YYYY', 'NLS_DATE_LANGUAGE=SPANISH')) AS "Fecha Emisión",
    LPAD(RUTCLIENTE, 10, '0') AS "RUT Cliente",
    TO_CHAR(ROUND(NETO, 0), 'FM$999G999', 'NLS_NUMERIC_CHARACTERS=,.') AS "Monto Neto",
    TO_CHAR(ROUND(IVA, 0), 'FM$999G999', 'NLS_NUMERIC_CHARACTERS=,.') AS "Monto Iva",
    TO_CHAR(ROUND(TOTALFACTURA, 0), 'FM$999G999', 'NLS_NUMERIC_CHARACTERS=,.') AS "Total Factura",
    CASE
        WHEN TOTALFACTURA <= 50000 THEN 'Bajo'
        WHEN TOTALFACTURA <= 100000 THEN 'Medio'
        ELSE 'Alto'
    END AS "Categoría Monto",
    UPPER(
        CASE
            WHEN CODPAGO = 1 THEN 'EFECTIVO'
            WHEN CODPAGO = 2 THEN 'TARJETA DEBITO'
            WHEN CODPAGO = 3 THEN 'TARJETA CREDITO'
            ELSE 'CHEQUE'
        END
    ) AS "Forma de pago"
FROM FACTURA
WHERE EXTRACT(YEAR FROM FECHAEMISION) = EXTRACT(YEAR FROM SYSDATE) - 1
ORDER BY FECHAEMISION DESC, NETO DESC;


SELECT
    LPAD(REVERSE(RUTCLIENTE), 10, '*') AS "RUT",
    NOMBRE AS "Cliente",
    NVL(TO_CHAR(TELEFONO), 'Sin teléfono') AS "TELÉFONO",
    NVL((SELECT DESCRIPCION FROM COMUNA C WHERE C.CODCOMUNA = CLIENTE.CODCOMUNA), 'Sin comuna') AS "COMUNA",
    ESTADO AS "ESTADO",
    CASE
        WHEN CREDITO > 0 AND ROUND(SALDO/CREDITO, 2) < 0.5 THEN
            'Bueno ( $' || TO_CHAR(CREDITO-SALDO, '999G999G999', 'NLS_NUMERIC_CHARACTERS=,.') || ' )'
        WHEN CREDITO > 0 AND ROUND(SALDO/CREDITO, 2) >= 0.5 AND ROUND(SALDO/CREDITO, 2) <= 0.8 THEN
            'Regular ( $' || TO_CHAR(SALDO, '999G999G999', 'NLS_NUMERIC_CHARACTERS=,.') || ' )'
        WHEN CREDITO > 0 AND ROUND(SALDO/CREDITO, 2) > 0.8 THEN
            'Crítico'
        ELSE
            'Sin clasificación'
    END AS "Estado Crédito",
    UPPER(
        CASE
            WHEN MAIL IS NULL THEN 'Correo no registrado'
            ELSE SUBSTR(MAIL, INSTR(MAIL, '@')+1)
        END
    ) AS "Dominio Correo"
FROM CLIENTE
WHERE ESTADO = 'A' AND CREDITO > 0
ORDER BY NOMBRE ASC;


SELECT
    COPRODUCTO AS "ID",
    DESCRIPCION AS "Descripción de Producto",

    CASE
        WHEN VALORCOMPRAALCUR1 IS NULL THEN 'Sin registro'
        ELSE TO_CHAR(VALORCOMPRAALCUR1, 'FM999G999D99', 'NLS_NUMERIC_CHARACTERS=,.') || ' USD'
    END AS "Compra en USD",

    CASE
        WHEN VALORCOMPRAALCUR1 IS NULL THEN 'Sin registro'
        ELSE '$' || TO_CHAR(ROUND(VALORCOMPRAALCUR1 * 1000, 0), 'FM999G999', 'NLS_NUMERIC_CHARACTERS=,.') || ' PESOS'
    END AS "USD convertido",

    CASE
        WHEN STOCK IS NULL THEN 'Sin registro'
        ELSE TO_CHAR(STOCK)
    END AS "Stock",

    CASE
        WHEN STOCK IS NULL THEN 'Sin datos'
        WHEN STOCK < 30 THEN '¡ALERTA stock muy bajo!'
        WHEN STOCK >= 30 AND STOCK <= 80 THEN '¡Reabastecer pronto!'
        WHEN STOCK > 80 THEN 'OK'
        ELSE 'Sin datos'
    END AS "Alerta Stock",
  
    CASE
        WHEN STOCK > 80 AND VALORCOMPRAALCUR1 IS NOT NULL THEN
            '$' || TO_CHAR(ROUND(VALORCOMPRAALCUR1 * 1000 * 0.9, 0), 'FM999G999', 'NLS_NUMERIC_CHARACTERS=,.')
        ELSE 'N/A'
    END AS "Precio Oferta"
FROM PRODUCTO
WHERE LOWER(DESCRIPCION) LIKE '%zapato%'
  AND LOWER(PROCEDENCIA) = 'i'
ORDER BY COPRODUCTO DESC;